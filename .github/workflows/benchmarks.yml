name: Benchmarks

on:
  workflow_dispatch:  # Allow manual triggering
  pull_request:
    paths:
      - 'src/**'
      - 'benchmark/**'
      - '.github/workflows/benchmarks.yml'
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'benchmark/**'

jobs:
  benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Julia
        uses: julia-actions/setup-julia@v2
        with:
          version: '1'
          arch: x64

      - name: Cache Julia artifacts
        uses: actions/cache@v4
        env:
          cache-name: cache-artifacts-benchmarks
        with:
          path: ~/.julia/artifacts
          key: ${{ runner.os }}-benchmark-${{ env.cache-name }}-${{ hashFiles('**/Project.toml') }}
          restore-keys: |
            ${{ runner.os }}-benchmark-${{ env.cache-name }}-
            ${{ runner.os }}-benchmark-
            ${{ runner.os }}-

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfftw3-dev

      - name: Setup benchmark environments
        run: |
          cd benchmark

          # Setup FFTA environment
          julia --project=ffta_env -e 'import Pkg; Pkg.instantiate(); Pkg.develop(path="..")'

          # Setup FFTW environment
          julia --project=fftw_env -e 'import Pkg; Pkg.instantiate()'

          # Setup plotting environment
          julia --project=. -e 'import Pkg; Pkg.instantiate()'

      - name: Run benchmarks
        run: |
          cd benchmark
          julia --project=. run_benchmarks.jl

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: benchmark-results
          path: |
            benchmark/benchmark_report.html
            benchmark/*.png
            benchmark/*.json
          retention-days: 30

      - name: Upload HTML report as GitHub Pages artifact (if on main)
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-pages-artifact@v3
        with:
          path: benchmark/
          name: benchmark-pages

      - name: Comment benchmark results on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Read summary from results
            const fftaResults = JSON.parse(fs.readFileSync('benchmark/results_ffta.json', 'utf8'));
            const fftwResults = JSON.parse(fs.readFileSync('benchmark/results_fftw.json', 'utf8'));

            // Create summary table
            let comment = '## ðŸ“Š Benchmark Results\n\n';
            comment += 'Performance comparison between FFTA.jl and FFTW.jl:\n\n';
            comment += '| Category | Array Size | FFTA (Î¼s) | FFTW (Î¼s) | Speedup |\n';
            comment += '|----------|------------|-----------|-----------|----------|\n';

            const categories = {
              'odd_power_of_2': 'Odd Powers of 2',
              'even_power_of_2': 'Even Powers of 2',
              'power_of_3': 'Powers of 3',
              'composite': 'Composite'
            };

            // Sample a few sizes from each category for the summary
            const sampleSizes = [8, 128, 1024, 8192];

            for (const [catKey, catName] of Object.entries(categories)) {
              for (const size of sampleSizes) {
                const fftaData = fftaResults.data.find(d => d.size === size && d.category === catKey);
                const fftwData = fftwResults.data.find(d => d.size === size && d.category === catKey);

                if (fftaData && fftwData) {
                  const fftaTime = (fftaData.median_time * 1e6).toFixed(3);
                  const fftwTime = (fftwData.median_time * 1e6).toFixed(3);
                  const speedup = (fftwData.median_time / fftaData.median_time).toFixed(2);
                  const speedupText = speedup > 1 ? `${speedup}x (FFTA faster)` : `${(1/speedup).toFixed(2)}x (FFTW faster)`;

                  comment += `| ${catName} | ${size} | ${fftaTime} | ${fftwTime} | ${speedupText} |\n`;
                }
              }
            }

            comment += '\nðŸ“ˆ **[View detailed HTML report in artifacts](';
            comment += `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})**\n`;

            // Post comment
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Summary
        if: always()
        run: |
          echo "## Benchmark Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Benchmarks completed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š Results are available as artifacts above" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ˆ Download the HTML report for detailed visualizations" >> $GITHUB_STEP_SUMMARY
